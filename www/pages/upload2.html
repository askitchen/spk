<template>
  <div data-name="upload" class="page">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="left">
            <a href="#" class="link back">
                <i class="icon icon-back"></i>
                <span class="ios-only">Back</span>
            </a>
        </div>
        <div class="center">Upload Foto</div>
        <div class="right"><a href="#" class="link open-panel icon-only"><i class="icon icon-bars"></i></a></div>
      </div>
    </div>
    <div class="page-content">

      <div class="content-block">
        <form class="upload-form form-ajax-submit">
          <input type="hidden" name="filedata" value="" id="filedata" />
          <input type="hidden" name="komentar" value="" id="komentar" />
        </form>
      </div>

      <div class="card">
        <!-- <div class="card-header"></div> -->
        <div class="card-content">
          <div class="card-content-inner"><img id="cameraimage" src="img/noimage.png" style="height: 480px;" width="100%"></div>
        </div>
        <div class="card-content">
          <div class="card-content-inner">
            <div class="item-input-wrap">
              <textarea id="info" placeholder="Tulis komentar" style="height: 220px;" width="100%"></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="#" class="button button-fill color-blue btn-foto">Ambil Foto</a>
          <a href="#" spkid="{{spkid}}" class="button button-fill color-blue btn-upload">Upload Foto</a>
        </div>
      </div>
  </div>
</template>
<script>
    return {
      // Page Events
      on: {
        
        pageInit: function(e, page) {
          
          // ambil foto
          $$('.btn-foto').on('click', function (e) {

            var options = {
              quality: 50,
              destinationType: destinationType.DATA_URL,
              sourceType: pictureSource.CAMERA,
              encodingType: Camera.EncodingType.JPEG,
              mediaType: Camera.MediaType.PICTURE,
              targetWidth: 320, // 360
              targetHeight: 480, // 360
              allowEdit: true,
              correctOrientation: true  //Corrects Android orientation quirks
              // popoverOptions: CameraPopoverOptions,
              // saveToPhotoAlbum: false
            };

            // update camera image directive
            navigator.camera.getPicture(function cameraSuccess(imageData) {
              $$('#cameraimage').attr('src', "data:image/jpeg; base64," + imageData);
              $$('#filedata').val(imageData);
            }, function cameraError(err) {
              // console.log('Failed because: ');
              app.dialog.alert(err);
            }, options);

          });
          
          
          // upload foto ke server
          $$('.btn-upload').on('click', function (e) {
            
            // ambil nomor SPK
            var $btnEl = e.srcElement;
            var number = $$($btnEl).attr('spkid');

            var formData = app.form.convertToData('.upload-form');
            
            app.preloader.show();
            
            app.request.post('https://apgroup.id/api/spk/finish/' + number, formData,
            
            function (res) { // sukses
              
              app.preloader.hide();
              
              var view = app.views.current;
              view.router.back(view.history[0], { force: true });

              /*
              // get current date
              var now = new Date();
              var date = now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate();

          
              app.request({
                url: "https://apgroup.id/api/resource/Delivery Note/" + strEncode,
                method: 'PUT',
                contentType: 'application/json',
                data: '{ "deliver_date" : "'+ date + '"}',
                statusCode: {
                  
                  200: function (xhr) {
                    var view = app.views.current;
                    view.router.back(view.history[0], { force: true });
                  }
                }
              })*/

            },
            function (xhr, status) { // gagal
    
              app.preloader.hide();
              app.dialog.alert('Upload foto gagal!', 'Login User');
            });
          });
        }
      }
    }
</script>